{"version":3,"file":"index.cjs.js","sources":["../src/bitcoinish/utils.ts","../src/bitcoinish/types.ts","../src/bitcoinish/BlockbookConnected.ts","../src/bitcoinish/BitcoinishPaymentsUtils.ts","../src/bitcoinish/BitcoinishPayments.ts","../src/types.ts","../src/constants.ts","../src/utils.ts","../src/helpers.ts","../src/BaseBitcoinPayments.ts","../src/bip44.ts","../src/HdBitcoinPayments.ts","../src/BitcoinPaymentsUtils.ts","../src/BitcoinPaymentsFactory.ts"],"sourcesContent":["import { NetworkType, UtxoInfo } from '@faast/payments-common'\nimport { BlockbookConnectedConfig } from './types'\nimport { BlockbookBitcoin } from 'blockbook-client'\nimport { isString, Logger, isMatchingError, toBigNumber } from '@faast/ts-common'\nimport promiseRetry from 'promise-retry'\n\nexport function resolveServer(server: BlockbookConnectedConfig['server'], network: NetworkType): {\n  api: BlockbookBitcoin\n  server: string | null\n} {\n  if (isString(server)) {\n    return {\n      api: new BlockbookBitcoin({\n        nodes: [server],\n      }),\n      server,\n    }\n  } else if (server instanceof BlockbookBitcoin) {\n    return {\n      api: server,\n      server: server.nodes[0] || '',\n    }\n  } else {\n    // null server arg -> offline mode\n    return {\n      api: new BlockbookBitcoin({\n        nodes: [''],\n      }),\n      server: null,\n    }\n  }\n}\n\nconst RETRYABLE_ERRORS = ['timeout', 'disconnected']\nconst MAX_RETRIES = 3\n\nexport function retryIfDisconnected<T>(fn: () => Promise<T>, api: BlockbookBitcoin, logger: Logger): Promise<T> {\n  return promiseRetry(\n    (retry, attempt) => {\n      return fn().catch(async e => {\n        if (isMatchingError(e, RETRYABLE_ERRORS)) {\n          logger.log(\n            `Retryable error during blockbook server call, retrying ${MAX_RETRIES - attempt} more times`,\n            e.toString(),\n          )\n          retry(e)\n        }\n        throw e\n      })\n    },\n    {\n      retries: MAX_RETRIES,\n    },\n  )\n}\n\n/**\n * Estimate size of transaction a certain number of inputs and outputs.\n * This function is based off of ledger-wallet-webtool/src/TransactionUtils.js#estimateTransactionSize\n */\nexport function estimateTxSize (inputsCount: number, outputsCount: number, handleSegwit: boolean) {\n  let maxNoWitness\n  let maxSize\n  let maxWitness\n  let minNoWitness\n  let minSize\n  let minWitness\n  let varintLength\n\n  if (inputsCount < 0xfd) {\n    varintLength = 1\n  } else if (inputsCount < 0xffff) {\n    varintLength = 3\n  } else {\n    varintLength = 5\n  }\n  if (handleSegwit) {\n    minNoWitness =\n      varintLength + 4 + 2 + 59 * inputsCount + 1 + 31 * outputsCount + 4\n    maxNoWitness =\n      varintLength + 4 + 2 + 59 * inputsCount + 1 + 33 * outputsCount + 4\n    minWitness =\n      varintLength +\n      4 +\n      2 +\n      59 * inputsCount +\n      1 +\n      31 * outputsCount +\n      4 +\n      106 * inputsCount\n    maxWitness =\n      varintLength +\n      4 +\n      2 +\n      59 * inputsCount +\n      1 +\n      33 * outputsCount +\n      4 +\n      108 * inputsCount\n    minSize = (minNoWitness * 3 + minWitness) / 4\n    maxSize = (maxNoWitness * 3 + maxWitness) / 4\n  } else {\n    minSize = varintLength + 4 + 146 * inputsCount + 1 + 31 * outputsCount + 4\n    maxSize = varintLength + 4 + 148 * inputsCount + 1 + 33 * outputsCount + 4\n  }\n  return {\n    min: minSize,\n    max: maxSize\n  }\n}\n\nexport function estimateTxFee (satPerByte: number, inputsCount: number, outputsCount: number, handleSegwit: boolean) {\n  const { min, max } = estimateTxSize(inputsCount, outputsCount, handleSegwit)\n  const mean = Math.ceil((min + max) / 2)\n  return mean * satPerByte\n}\n\n/**\n * Sort the utxos for input selection\n */\nexport function sortUtxos(utxoList: UtxoInfo[]): UtxoInfo[] {\n  const matureList: UtxoInfo[] = []\n  const immatureList: UtxoInfo[] = []\n  utxoList.forEach((utxo) => {\n    if (utxo.confirmations && utxo.confirmations >= 6) {\n      matureList.push(utxo)\n    } else {\n      immatureList.push(utxo)\n    }\n  })\n  matureList.sort((a, b) => toBigNumber(a.value).minus(b.value).toNumber()) // Ascending order by value\n  immatureList.sort((a, b) => (b.confirmations || 0) - (a.confirmations || 0)) // Descending order by confirmations\n  return matureList.concat(immatureList)\n}\n","import * as t from 'io-ts'\nimport {\n  BaseUnsignedTransaction, BaseSignedTransaction, FeeRate, AutoFeeLevels,\n  BaseTransactionInfo, BaseBroadcastResult, UtxoInfo, NetworkTypeT,\n} from '@faast/payments-common'\nimport { extendCodec, nullable, instanceofCodec, requiredOptionalCodec, Logger } from '@faast/ts-common'\nimport { Network as BitcoinjsNetwork } from 'bitcoinjs-lib'\nimport { BlockbookBitcoin, BlockInfoBitcoin } from 'blockbook-client'\n\nexport { BitcoinjsNetwork, UtxoInfo }\n\n/** A hack to get around TS2742 when config is re-exported from coin-payments */\nexport class BlockbookServerAPI extends BlockbookBitcoin {}\n\nexport const BlockbookConfigServer = t.union([t.string, instanceofCodec(BlockbookServerAPI), t.null], 'BlockbookConfigServer')\nexport type BlockbookConfigServer = t.TypeOf<typeof BlockbookConfigServer>\n\nexport const BlockbookConnectedConfig = requiredOptionalCodec(\n  {\n    network: NetworkTypeT,\n    server: BlockbookConfigServer,\n  },\n  {\n    logger: nullable(Logger),\n  },\n  'BlockbookConnectedConfig',\n)\nexport type BlockbookConnectedConfig = t.TypeOf<typeof BlockbookConnectedConfig>\n\nexport type BitcoinishPaymentsUtilsConfig = BlockbookConnectedConfig & {\n  coinSymbol: string,\n  coinName: string,\n  bitcoinjsNetwork: BitcoinjsNetwork,\n  decimals: number,\n}\n\nexport type BitcoinishPaymentsConfig = BitcoinishPaymentsUtilsConfig & {\n  minTxFee: FeeRate,\n  dustThreshold: number,\n  networkMinRelayFee: number,\n  isSegwit: boolean,\n  defaultFeeLevel: AutoFeeLevels,\n}\n\nexport const BitcoinishTxOutput = t.type({\n  address: t.string,\n  value: t.string,\n}, 'BitcoinishTxOutput')\nexport type BitcoinishTxOutput = t.TypeOf<typeof BitcoinishTxOutput>\n\nexport const BitcoinishPaymentTx = t.type({\n  inputs: t.array(UtxoInfo),\n  outputs: t.array(BitcoinishTxOutput),\n  fee: t.string,\n  change: t.string,\n  changeAddress: nullable(t.string),\n}, 'BitcoinishPaymentTx')\nexport type BitcoinishPaymentTx = t.TypeOf<typeof BitcoinishPaymentTx>\n\nexport const BitcoinishUnsignedTransaction = extendCodec(\n  BaseUnsignedTransaction,\n  {\n    amount: t.string,\n    fee: t.string,\n  },\n  'BitcoinishUnsignedTransaction',\n)\nexport type BitcoinishUnsignedTransaction = t.TypeOf<typeof BitcoinishUnsignedTransaction>\n\nexport const BitcoinishSignedTransaction = extendCodec(BaseSignedTransaction, {\n  data: t.type({\n    hex: t.string,\n  }),\n}, {}, 'BitcoinishSignedTransaction')\nexport type BitcoinishSignedTransaction = t.TypeOf<typeof BitcoinishSignedTransaction>\n\nexport const BitcoinishTransactionInfo = extendCodec(BaseTransactionInfo, {}, {}, 'BitcoinishTransactionInfo')\nexport type BitcoinishTransactionInfo = t.TypeOf<typeof BitcoinishTransactionInfo>\n\nexport const BitcoinishBroadcastResult = extendCodec(BaseBroadcastResult, {}, {}, 'BitcoinishBroadcastResult')\nexport type BitcoinishBroadcastResult = t.TypeOf<typeof BitcoinishBroadcastResult>\n\nexport const BitcoinishBlock = BlockInfoBitcoin\nexport type BitcoinishBlock = BlockInfoBitcoin\n","import { NetworkType } from '@faast/payments-common'\nimport { Logger, assertType, DelegateLogger } from '@faast/ts-common'\nimport { BlockbookBitcoin } from 'blockbook-client'\n\nimport { BlockbookConnectedConfig } from './types'\nimport { DEFAULT_NETWORK, PACKAGE_NAME } from '../constants'\nimport { resolveServer, retryIfDisconnected } from './utils'\n\nexport abstract class BlockbookConnected {\n  networkType: NetworkType\n  logger: Logger\n  api: BlockbookBitcoin | null\n  server: string | null\n\n  constructor(config: BlockbookConnectedConfig) {\n    assertType(BlockbookConnectedConfig, config)\n    this.networkType = config.network\n    this.logger = new DelegateLogger(config.logger)\n    const { api, server } = resolveServer(config.server, this.networkType)\n    this.api = api\n    this.server = server\n  }\n\n  getApi(): BlockbookBitcoin {\n    if (this.api === null) {\n      throw new Error('Cannot access Bitcoin network when configured with null server')\n    }\n    return this.api\n  }\n\n  async init(): Promise<void> {}\n\n  async destroy(): Promise<void> {}\n\n  async _retryDced<T>(fn: () => Promise<T>): Promise<T> {\n    return retryIfDisconnected(fn, this.getApi(), this.logger)\n  }\n}\n","import { PaymentsUtils, Payport, createUnitConverters } from '@faast/payments-common'\nimport { Network as BitcoinjsNetwork } from 'bitcoinjs-lib'\nimport { isNil, assertType, Numeric, isUndefined } from '@faast/ts-common'\nimport { BlockbookConnected } from './BlockbookConnected'\nimport { BitcoinishBlock, BitcoinishPaymentsUtilsConfig } from './types'\n\ntype UnitConverters = ReturnType<typeof createUnitConverters>\n\nexport abstract class BitcoinishPaymentsUtils extends BlockbookConnected implements PaymentsUtils {\n\n  decimals: number\n  bitcoinjsNetwork: BitcoinjsNetwork\n\n  constructor(config: BitcoinishPaymentsUtilsConfig) {\n    super(config)\n    this.decimals = config.decimals\n    this.bitcoinjsNetwork = config.bitcoinjsNetwork\n    const unitConverters = createUnitConverters(this.decimals)\n    this.toMainDenominationString = unitConverters.toMainDenominationString\n    this.toMainDenominationNumber = unitConverters.toMainDenominationNumber\n    this.toMainDenominationBigNumber = unitConverters.toMainDenominationBigNumber\n    this.toBaseDenominationString = unitConverters.toBaseDenominationString\n    this.toBaseDenominationNumber = unitConverters.toBaseDenominationNumber\n    this.toBaseDenominationBigNumber = unitConverters.toBaseDenominationBigNumber\n  }\n\n  async isValidExtraId(extraId: string): Promise<boolean> {\n    return false // utxo coins don't use extraIds\n  }\n\n  abstract async isValidAddress(address: string): Promise<boolean>\n\n  private async _getPayportValidationMessage(payport: Payport): Promise<string | undefined> {\n    const { address, extraId } = payport\n    if (!await this.isValidAddress(address)) {\n      return 'Invalid payport address'\n    }\n    if (!isNil(extraId)) {\n      return 'Invalid payport extraId'\n    }\n  }\n\n  async getPayportValidationMessage(payport: Payport): Promise<string | undefined> {\n    try {\n      payport = assertType(Payport, payport, 'payport')\n    } catch (e) {\n      return e.message\n    }\n    return this._getPayportValidationMessage(payport)\n  }\n\n  async validatePayport(payport: Payport): Promise<void> {\n    payport = assertType(Payport, payport, 'payport')\n    const message = await this._getPayportValidationMessage(payport)\n    if (message) {\n      throw new Error(message)\n    }\n  }\n\n  async isValidPayport(payport: Payport): Promise<boolean> {\n    return Payport.is(payport) && !(await this._getPayportValidationMessage(payport))\n  }\n\n  toMainDenomination(amount: Numeric): string {\n    return this.toMainDenominationString(amount)\n  }\n\n  toBaseDenomination(amount: Numeric): string {\n    return this.toBaseDenominationString(amount)\n  }\n\n  toMainDenominationString: UnitConverters['toMainDenominationString']\n  toMainDenominationNumber: UnitConverters['toMainDenominationNumber']\n  toMainDenominationBigNumber: UnitConverters['toMainDenominationBigNumber']\n\n  toBaseDenominationString: UnitConverters['toMainDenominationString']\n  toBaseDenominationNumber: UnitConverters['toMainDenominationNumber']\n  toBaseDenominationBigNumber: UnitConverters['toMainDenominationBigNumber']\n\n  async getBlock(id?: string | number): Promise<BitcoinishBlock> {\n    if (isUndefined(id)) {\n      id = (await this.getApi().getStatus()).backend.bestBlockHash\n    }\n    return this.getApi().getBlock(id)\n  }\n}\n","import {\n  BasePayments, UtxoInfo, FeeOptionCustom, FeeRateType, FeeRate, FeeOption,\n  ResolvedFeeOption, FeeLevel, AutoFeeLevels, Payport, ResolveablePayport,\n  BalanceResult, NetworkType, FromTo, TransactionStatus, CreateTransactionOptions, BaseConfig,\n} from '@faast/payments-common'\nimport { isUndefined, isType, Numeric, toBigNumber } from '@faast/ts-common'\nimport BigNumber from 'bignumber.js'\nimport { get } from 'lodash'\n\nimport {\n  BitcoinishUnsignedTransaction, BitcoinishSignedTransaction, BitcoinishBroadcastResult, BitcoinishTransactionInfo,\n  BitcoinishPaymentsConfig, BlockbookConnectedConfig,\n  BitcoinishPaymentTx, BitcoinishTxOutput,\n  BitcoinishPaymentsUtilsConfig,\n} from './types'\nimport { sortUtxos, estimateTxFee } from './utils'\nimport { BitcoinishPaymentsUtils } from './BitcoinishPaymentsUtils'\n\nexport abstract class BitcoinishPayments<Config extends BaseConfig> extends BitcoinishPaymentsUtils\n  implements BasePayments<\n    Config,\n    BitcoinishUnsignedTransaction,\n    BitcoinishSignedTransaction,\n    BitcoinishBroadcastResult,\n    BitcoinishTransactionInfo\n  > {\n  coinSymbol: string\n  coinName: string\n  minTxFee?: FeeRate\n  dustThreshold: number\n  networkMinRelayFee: number\n  isSegwit: boolean\n  defaultFeeLevel: AutoFeeLevels\n\n  constructor(config: BitcoinishPaymentsConfig) {\n    super(config)\n    this.coinSymbol = config.coinSymbol\n    this.coinName = config.coinName\n    this.decimals = config.decimals\n    this.bitcoinjsNetwork = config.bitcoinjsNetwork\n    this.minTxFee = config.minTxFee\n    this.dustThreshold = config.dustThreshold\n    this.networkMinRelayFee = config.networkMinRelayFee\n    this.isSegwit = config.isSegwit\n    this.defaultFeeLevel = config.defaultFeeLevel\n  }\n\n  abstract getFullConfig(): Config\n  abstract getPublicConfig(): Config\n  abstract getAccountId(index: number): string\n  abstract getAccountIds(): string[]\n  abstract getAddress(index: number): string\n  abstract getFeeRateRecommendation(feeLevel: AutoFeeLevels): Promise<FeeRate>\n  abstract isValidAddress(address: string): Promise<boolean>\n  abstract signTransaction(tx: BitcoinishUnsignedTransaction): Promise<BitcoinishSignedTransaction>\n\n  async init() {}\n  async destroy() {}\n\n  requiresBalanceMonitor() {\n    return false\n  }\n\n  isSweepableBalance(balance: Numeric): boolean {\n    return this.toBaseDenominationNumber(balance) > this.networkMinRelayFee\n  }\n\n  async getPayport(index: number): Promise<Payport> {\n    return { address: this.getAddress(index) }\n  }\n\n  async resolvePayport(payport: ResolveablePayport): Promise<Payport> {\n    if (typeof payport === 'number') {\n      return this.getPayport(payport)\n    } else if (typeof payport === 'string') {\n      if (!await this.isValidAddress(payport)) {\n        throw new Error(`Invalid BTC address: ${payport}`)\n      }\n      return { address: payport }\n    } else if (Payport.is(payport)) {\n      if (!await this.isValidAddress(payport.address)) {\n        throw new Error(`Invalid BTC payport.address: ${payport.address}`)\n      }\n      return payport\n    } else {\n      throw new Error('Invalid payport')\n    }\n  }\n\n  _feeRateToSatoshis(\n    { feeRate, feeRateType }: FeeRate,\n    inputCount: number,\n    outputCount: number,\n  ): number {\n    if (feeRateType === FeeRateType.BasePerWeight) {\n      return estimateTxFee(Number.parseFloat(feeRate), inputCount, outputCount, this.isSegwit)\n    } else if (feeRateType === FeeRateType.Main) {\n      return this.toBaseDenominationNumber(feeRate)\n    }\n    return Number.parseFloat(feeRate)\n  }\n\n  _calculatTxFeeSatoshis(\n    targetRate: FeeRate,\n    inputCount: number,\n    outputCount: number,\n  ) {\n    let feeSat = this._feeRateToSatoshis(targetRate, inputCount, outputCount)\n    // Ensure calculated fee is above network minimum\n    if (this.minTxFee) {\n      const minTxFeeSat = this._feeRateToSatoshis(this.minTxFee, inputCount, outputCount)\n      if (feeSat < minTxFeeSat) {\n        feeSat = minTxFeeSat\n      }\n    }\n    if (feeSat < this.networkMinRelayFee) {\n      feeSat = this.networkMinRelayFee\n    }\n    return Math.ceil(feeSat)\n  }\n\n  async resolveFeeOption(\n    feeOption: FeeOption,\n  ): Promise<ResolvedFeeOption> {\n    let targetLevel: FeeLevel\n    let target: FeeRate\n    let feeBase = ''\n    let feeMain = ''\n    if (isType(FeeOptionCustom, feeOption)) {\n      targetLevel = FeeLevel.Custom\n      target = feeOption\n    } else {\n      targetLevel = feeOption.feeLevel || this.defaultFeeLevel\n      target = await this.getFeeRateRecommendation(targetLevel)\n    }\n    if (target.feeRateType === FeeRateType.Base) {\n      feeBase = target.feeRate\n      feeMain = this.toMainDenominationString(feeBase)\n    } else if (target.feeRateType === FeeRateType.Main) {\n      feeMain = target.feeRate\n      feeBase = this.toBaseDenominationString(feeMain)\n    }\n    // in base/weight case total fees depend on input/output count, so just leave them as empty strings\n    return {\n      targetFeeLevel: targetLevel,\n      targetFeeRate: target.feeRate,\n      targetFeeRateType: target.feeRateType,\n      feeBase,\n      feeMain,\n    }\n  }\n\n  async getBalance(payport: ResolveablePayport): Promise<BalanceResult> {\n    const { address } = await this.resolvePayport(payport)\n    const result = await this._retryDced(() => this.getApi().getAddressDetails(address, { details: 'basic' }))\n    const confirmedBalance = this.toMainDenominationString(result.balance)\n    const unconfirmedBalance = this.toMainDenominationString(result.unconfirmedBalance)\n    this.logger.debug('getBalance', address, confirmedBalance, unconfirmedBalance)\n    return {\n      confirmedBalance,\n      unconfirmedBalance,\n      sweepable: this.isSweepableBalance(confirmedBalance)\n    }\n  }\n\n  usesUtxos() {\n    return true\n  }\n\n  async getUtxos(payport: ResolveablePayport): Promise<UtxoInfo[]> {\n    const { address } = await this.resolvePayport(payport)\n    let utxosRaw = await this.getApi().getUtxosForAddress(address)\n    const utxos: UtxoInfo[] = utxosRaw.map((data) => {\n      const { value, height, lockTime } = data\n      return {\n        ...data,\n        satoshis: value,\n        value: this.toMainDenominationString(value),\n        height: isUndefined(height) ? undefined : String(height),\n        lockTime: isUndefined(lockTime) ? undefined : String(lockTime),\n      }\n    })\n    return utxos\n  }\n\n  /**\n   * Sum the utxos values (main denomination)\n   */\n  _sumUtxoValue(utxos: UtxoInfo[]): BigNumber {\n    return utxos.reduce((total, { value }) => toBigNumber(value).plus(total), new BigNumber(0))\n  }\n\n  usesSequenceNumber() {\n    return false\n  }\n\n  async getNextSequenceNumber() {\n    return null\n  }\n\n  async resolveFromTo(from: number, to: ResolveablePayport): Promise<FromTo> {\n    const fromPayport = await this.getPayport(from)\n    const toPayport = await this.resolvePayport(to)\n    return {\n      fromAddress: fromPayport.address,\n      fromIndex: from,\n      fromExtraId: fromPayport.extraId,\n      fromPayport,\n      toAddress: toPayport.address,\n      toIndex: typeof to === 'number' ? to : null,\n      toExtraId: toPayport.extraId,\n      toPayport,\n    }\n  }\n\n  /**\n   * Build a simple payment transaction.\n   * Note: fee will be subtracted from first output when attempting to send entire account balance\n   * Note: All amounts/values should be input and output as main denomination strings for consistent\n   * serialization. Within this function they're converted to JS Numbers for convenient arithmetic\n   * then converted back to strings before being returned.\n   */\n  async buildPaymentTx(\n    allUtxos: UtxoInfo[],\n    desiredOutputs: Array<BitcoinishTxOutput>,\n    changeAddress: string,\n    desiredFeeRate: FeeRate,\n    useAllUtxos: boolean = false,\n  ): Promise<BitcoinishPaymentTx> {\n    let outputTotal = 0\n    const outputs = desiredOutputs.map(({ address, value }) => ({\n      address,\n      satoshis: this.toBaseDenominationNumber(value),\n    }))\n    for (let i = 0; i < outputs.length; i++) {\n      const { address, satoshis } = outputs[i]\n      // validate\n      if (!await this.isValidAddress(address)) {\n        throw new Error(`Invalid ${this.coinSymbol} address ${address} provided for output ${i}`)\n      }\n      if (satoshis <= 0) {\n        throw new Error(`Invalid ${this.coinSymbol} amount ${satoshis} provided for output ${i}`)\n      }\n      outputTotal += satoshis\n    }\n    const outputCount = outputs.length + 1 // Plus one for change output\n\n    /* Select inputs and calculate appropriate fee */\n    let inputUtxos = []\n    let inputTotal = 0\n    let feeSat = 0 // Total fee is recalculated when adding each input\n    let amountWithFee = outputTotal + feeSat\n    if (useAllUtxos) {\n      inputUtxos = allUtxos\n      inputTotal = this.toBaseDenominationNumber(this._sumUtxoValue(allUtxos))\n      feeSat = this._calculatTxFeeSatoshis(desiredFeeRate, inputUtxos.length, outputCount)\n      amountWithFee = outputTotal + feeSat\n      this.logger.debug('buildPaymentTx', { inputTotal, feeSat, amountWithFee })\n    } else {\n      const sortedUtxos = sortUtxos(allUtxos)\n      for (const utxo of sortedUtxos) {\n        inputUtxos.push(utxo)\n        inputTotal = inputTotal + this.toBaseDenominationNumber(utxo.value)\n        feeSat = this._calculatTxFeeSatoshis(desiredFeeRate, inputUtxos.length, outputCount)\n        amountWithFee = outputTotal + feeSat\n        if (inputTotal >= amountWithFee) {\n          break\n        }\n      }\n    }\n    if (amountWithFee > inputTotal) {\n      const amountWithSymbol = `${this.toMainDenominationString(outputTotal)} ${this.coinSymbol}`\n      if (outputTotal === inputTotal) {\n        this.logger.debug(`Attempting to send entire ${amountWithSymbol} balance. ` +\n          `Subtracting fee of ${feeSat} sat from first output.`)\n        amountWithFee = outputTotal\n        outputs[0].satoshis -= feeSat\n        outputTotal -= feeSat\n        if (outputs[0].satoshis <= this.dustThreshold) {\n          throw new Error(`First ${this.coinSymbol} output minus fee is below dust threshold`)\n        }\n      } else {\n        const { feeRate, feeRateType } = desiredFeeRate\n        const feeText = `${feeRate} ${feeRateType}${feeRateType === FeeRateType.BasePerWeight ? ` (${this.toMainDenominationString(feeSat)})` : ''}`\n        throw new Error(`You do not have enough UTXOs (${this.toMainDenominationString(inputTotal)}) to send ${amountWithSymbol} with ${feeText} fee`)\n      }\n    }\n\n    let changeSat = inputTotal - amountWithFee\n    let change = this.toMainDenominationString(changeSat)\n    if (changeSat > this.dustThreshold) { // Avoid creating dust outputs\n      outputs.push({ address: changeAddress, satoshis: changeSat })\n    } else if (changeSat > 0) {\n      this.logger.log(`${this.coinSymbol} change of ${changeSat} sat is below dustThreshold of ${this.dustThreshold}, adding to fee`)\n      feeSat += changeSat\n      changeSat = 0\n      change = '0'\n    }\n    return {\n      inputs: inputUtxos,\n      outputs: outputs.map(({ address, satoshis }) => ({ address, value: this.toMainDenominationString(satoshis) })),\n      fee: this.toMainDenominationString(feeSat),\n      change,\n      changeAddress,\n    }\n  }\n\n  async createTransaction(\n    from: number,\n    to: ResolveablePayport,\n    amountNumeric: Numeric,\n    options: CreateTransactionOptions = {},\n  ): Promise<BitcoinishUnsignedTransaction> {\n    this.logger.debug('createTransaction', from, to, amountNumeric)\n    const desiredAmount = toBigNumber(amountNumeric)\n    if (desiredAmount.isNaN() || desiredAmount.lte(0)) {\n      throw new Error(`Invalid ${this.coinSymbol} amount provided to createTransaction: ${desiredAmount}`)\n    }\n    const {\n      fromIndex, fromAddress, fromExtraId, toIndex, toAddress, toExtraId,\n    } = await this.resolveFromTo(from, to)\n\n    const allUtxos = isUndefined(options.utxos)\n      ? await this.getUtxos(from)\n      : options.utxos\n      this.logger.debug('createTransaction allUtxos', allUtxos)\n\n    const { targetFeeLevel, targetFeeRate, targetFeeRateType } = await this.resolveFeeOption(options)\n    this.logger.debug(`createTransaction resolvedFeeOption ${targetFeeLevel} ${targetFeeRate} ${targetFeeRateType}`)\n\n    const paymentTx = await this.buildPaymentTx(\n      allUtxos,\n      [{ address: toAddress, value: desiredAmount.toString() }],\n      fromAddress,\n      { feeRate: targetFeeRate, feeRateType: targetFeeRateType },\n      options.useAllUtxos,\n    )\n    this.logger.debug('createTransaction data', paymentTx)\n    const feeMain = paymentTx.fee\n\n    const actualAmount = paymentTx.outputs[0].value\n\n    return {\n      status: TransactionStatus.Unsigned,\n      id: null,\n      fromIndex,\n      fromAddress,\n      fromExtraId,\n      toIndex,\n      toAddress,\n      toExtraId,\n      amount: actualAmount,\n      targetFeeLevel,\n      targetFeeRate,\n      targetFeeRateType,\n      fee: feeMain,\n      sequenceNumber: null,\n      inputUtxos: paymentTx.inputs,\n      data: paymentTx,\n    }\n  }\n\n  async createSweepTransaction(\n    from: number,\n    to: ResolveablePayport,\n    options: CreateTransactionOptions = {},\n  ): Promise<BitcoinishUnsignedTransaction> {\n    this.logger.debug('createSweepTransaction', from, to, options)\n    const allUtxos = isUndefined(options.utxos)\n      ? await this.getUtxos(from)\n      : options.utxos\n    if (allUtxos.length === 0) {\n      throw new Error('No utxos to sweep')\n    }\n    const amount = this._sumUtxoValue(allUtxos)\n    if (!this.isSweepableBalance(amount)) {\n      throw new Error(`Balance ${amount} too low to sweep`)\n    }\n    return this.createTransaction(from, to, amount, {\n      ...options,\n      utxos: allUtxos,\n      useAllUtxos: true,\n    })\n  }\n\n  async broadcastTransaction(tx: BitcoinishSignedTransaction): Promise<BitcoinishBroadcastResult> {\n    const txId = await this._retryDced(() => this.getApi().sendTx(tx.data.hex))\n    if (tx.id !== txId) {\n      this.logger.warn(`Broadcasted ${this.coinSymbol} txid ${txId} doesn't match original txid ${tx.id}`)\n    }\n    return {\n      id: txId,\n    }\n  }\n\n  async getTransactionInfo(txId: string): Promise<BitcoinishTransactionInfo> {\n    const tx = await this._retryDced(() => this.getApi().getTx(txId))\n    const fee = this.toMainDenominationString(tx.fees)\n    const confirmationId = tx.blockHash || null\n    const confirmationNumber = tx.blockHeight ? String(tx.blockHeight) : undefined\n    const confirmationTimestamp = tx.blockTime ? new Date(tx.blockTime * 1000) : null\n    const isConfirmed = Boolean(confirmationNumber)\n    const status = isConfirmed ? TransactionStatus.Confirmed : TransactionStatus.Pending\n    const amountSat = get(tx, 'vout.0.value', tx.value)\n    const amount = this.toMainDenominationString(amountSat)\n    const fromAddress = get(tx, 'vin.0.addresses.0')\n    if (!fromAddress) {\n      throw new Error(`Unable to determine fromAddress of ${this.coinSymbol} tx ${txId}`)\n    }\n    const toAddress = get(tx, 'vout.0.addresses.0')\n    if (!toAddress) {\n      throw new Error(`Unable to determine toAddress of ${this.coinSymbol} tx ${txId}`)\n    }\n\n    return {\n      status,\n      id: tx.txid,\n      fromIndex: null,\n      fromAddress,\n      fromExtraId: null,\n      toIndex: null,\n      toAddress,\n      toExtraId: null,\n      amount,\n      fee,\n      sequenceNumber: null,\n      confirmationId,\n      confirmationNumber,\n      confirmationTimestamp,\n      isExecuted: isConfirmed,\n      isConfirmed,\n      confirmations: tx.confirmations,\n      data: tx,\n    }\n  }\n}\n","import * as t from 'io-ts'\nimport {\n  BaseConfig, BaseUnsignedTransaction, BaseSignedTransaction, FeeRate,\n  BaseTransactionInfo, BaseBroadcastResult, UtxoInfo,\n} from '@faast/payments-common'\nimport { extendCodec, enumCodec } from '@faast/ts-common'\nimport { Network as BitcoinjsNetwork } from 'bitcoinjs-lib'\nimport { BlockInfoBitcoin } from 'blockbook-client'\nimport { BitcoinishPaymentTx, BlockbookConfigServer } from './bitcoinish'\n\nexport { BitcoinjsNetwork, UtxoInfo }\nexport * from './bitcoinish/types'\n\nexport enum AddressType {\n  Legacy = 'p2pkh',\n  SegwitP2SH = 'p2sh-p2wpkh',\n  SegwitNative = 'p2wpkh',\n}\nexport const AddressTypeT = enumCodec<AddressType>(AddressType, 'AddressType')\n\nexport const BitcoinPaymentsUtilsConfig = extendCodec(\n  BaseConfig,\n  {},\n  {\n    server: BlockbookConfigServer,\n  },\n  'BitcoinPaymentsUtilsConfig',\n)\nexport type BitcoinPaymentsUtilsConfig = t.TypeOf<typeof BitcoinPaymentsUtilsConfig>\n\nexport const BaseBitcoinPaymentsConfig = extendCodec(\n  BitcoinPaymentsUtilsConfig,\n  {},\n  {\n    addressType: AddressTypeT,\n    minTxFee: FeeRate,\n    dustThreshold: t.number,\n    networkMinRelayFee: t.number,\n  },\n  'BaseBitcoinPaymentsConfig',\n)\nexport type BaseBitcoinPaymentsConfig = t.TypeOf<typeof BaseBitcoinPaymentsConfig>\n\nexport const HdBitcoinPaymentsConfig = extendCodec(\n  BaseBitcoinPaymentsConfig,\n  {\n    hdKey: t.string,\n  },\n  {\n    derivationPath: t.string,\n  },\n  'HdBitcoinPaymentsConfig',\n)\nexport type HdBitcoinPaymentsConfig = t.TypeOf<typeof HdBitcoinPaymentsConfig>\n\n// TODO: Add KeyPairBitcoinPaymentsConfig as a union to this once it exists\nexport const BitcoinPaymentsConfig = HdBitcoinPaymentsConfig\nexport type BitcoinPaymentsConfig = t.TypeOf<typeof BitcoinPaymentsConfig>\n\nexport const BitcoinUnsignedTransactionData = BitcoinishPaymentTx\nexport type BitcoinUnsignedTransactionData = t.TypeOf<typeof BitcoinUnsignedTransactionData>\n\nexport const BitcoinUnsignedTransaction = extendCodec(\n  BaseUnsignedTransaction,\n  {\n    amount: t.string,\n    fee: t.string,\n    data: BitcoinUnsignedTransactionData,\n  },\n  'BitcoinUnsignedTransaction',\n)\nexport type BitcoinUnsignedTransaction = t.TypeOf<typeof BitcoinUnsignedTransaction>\n\nexport const BitcoinSignedTransaction = extendCodec(BaseSignedTransaction, {\n  data: t.type({\n    hex: t.string,\n  }),\n}, {}, 'BitcoinSignedTransaction')\nexport type BitcoinSignedTransaction = t.TypeOf<typeof BitcoinSignedTransaction>\n\nexport const BitcoinTransactionInfo = extendCodec(BaseTransactionInfo, {}, {}, 'BitcoinTransactionInfo')\nexport type BitcoinTransactionInfo = t.TypeOf<typeof BitcoinTransactionInfo>\n\nexport const BitcoinBroadcastResult = extendCodec(BaseBroadcastResult, {}, {}, 'BitcoinBroadcastResult')\nexport type BitcoinBroadcastResult = t.TypeOf<typeof BitcoinBroadcastResult>\n\nexport const BitcoinBlock = BlockInfoBitcoin\nexport type BitcoinBlock = BlockInfoBitcoin\n","import { FeeLevel, NetworkType, FeeRateType } from '@faast/payments-common'\nimport { networks } from 'bitcoinjs-lib'\nimport { AddressType, BitcoinishPaymentsConfig } from './types'\n\nexport const PACKAGE_NAME = 'bitcoin-payments'\nexport const DECIMAL_PLACES = 8\nexport const COIN_SYMBOL = 'BTC'\nexport const COIN_NAME = 'Bitcoin'\n\n/**\n * The minimum value a transaction output must be in order to not get rejected by the network.\n *\n * Unit: `satoshis`\n */\nexport const DEFAULT_DUST_THRESHOLD = 546\n\n/**\n * The minimum fee required by *most* nodes to relay a transaction.\n *\n * Unit: `satoshis`\n */\nexport const DEFAULT_NETWORK_MIN_RELAY_FEE = 1000\n\n/**\n * The minimum fee this library should ever use for a transaction (overrides recommended levels).\n *\n * Unit: `sat/byte`\n */\nexport const DEFAULT_MIN_TX_FEE = 5\n\nexport const DEFAULT_ADDRESS_TYPE: AddressType = AddressType.SegwitNative\n\nexport const DEFAULT_DERIVATION_PATHS = {\n  [AddressType.Legacy]: \"m/44'/0'/0'\",\n  [AddressType.SegwitP2SH]: \"m/49'/0'/0'\",\n  [AddressType.SegwitNative]: \"m/84'/0'/0'\",\n}\n\nexport const DEFAULT_NETWORK = NetworkType.Mainnet\n\nexport const NETWORK_MAINNET = networks.bitcoin\nexport const NETWORK_TESTNET = networks.testnet\n\nexport const DEFAULT_MAINNET_SERVER = process.env.BITCOIN_SERVER_URL || 'https://btc1.trezor.io'\nexport const DEFAULT_TESTNET_SERVER = process.env.BITCOIN_TESTNET_SERVER_URL || 'https://tbtc1.trezor.io'\n\nexport const DEFAULT_FEE_LEVEL = FeeLevel.Medium\nexport const DEFAULT_SAT_PER_BYTE_LEVELS = {\n  [FeeLevel.High]: 50,\n  [FeeLevel.Medium]: 25,\n  [FeeLevel.Low]: 10,\n}\n","import { NetworkType, FeeLevel, FeeRateType, AutoFeeLevels } from '@faast/payments-common'\nimport request from 'request-promise-native'\nimport bs58 from 'bs58'\nimport { AddressType, BaseBitcoinPaymentsConfig } from './types'\nimport { BitcoinishPaymentsConfig } from './bitcoinish'\nimport {\n  DEFAULT_NETWORK,\n  NETWORK_TESTNET,\n  NETWORK_MAINNET,\n  DEFAULT_TESTNET_SERVER,\n  DEFAULT_MAINNET_SERVER,\n  DEFAULT_ADDRESS_TYPE,\n  COIN_SYMBOL,\n  COIN_NAME,\n  DECIMAL_PLACES,\n  DEFAULT_DUST_THRESHOLD,\n  DEFAULT_NETWORK_MIN_RELAY_FEE,\n  DEFAULT_MIN_TX_FEE,\n  DEFAULT_FEE_LEVEL,\n} from './constants'\n\nconst DEFAULT_BITCOINISH_CONFIG = {\n  coinSymbol: COIN_SYMBOL,\n  coinName: COIN_NAME,\n  decimals: DECIMAL_PLACES,\n  dustThreshold: DEFAULT_DUST_THRESHOLD,\n  networkMinRelayFee: DEFAULT_NETWORK_MIN_RELAY_FEE,\n  minTxFee: {\n    feeRate: DEFAULT_MIN_TX_FEE.toString(),\n    feeRateType: FeeRateType.BasePerWeight,\n  },\n  defaultFeeLevel: DEFAULT_FEE_LEVEL as AutoFeeLevels,\n}\n\nexport function bip32MagicNumberToPrefix(magicNum: number): string {\n  const b = Buffer.alloc(82)\n  b.writeUInt32BE(magicNum, 0)\n  return bs58.encode(b).slice(0, 4)\n}\n\nexport function toBitcoinishConfig<T extends BaseBitcoinPaymentsConfig>(config: T): BitcoinishPaymentsConfig {\n  const configWithDefaults = {\n    ...DEFAULT_BITCOINISH_CONFIG,\n    ...config,\n    network: config.network || DEFAULT_NETWORK,\n    addressType: config.addressType || DEFAULT_ADDRESS_TYPE,\n  }\n  const { network, server, addressType } = configWithDefaults\n  return {\n    ...configWithDefaults,\n    bitcoinjsNetwork: network === NetworkType.Testnet ? NETWORK_TESTNET : NETWORK_MAINNET,\n    isSegwit: addressType === AddressType.SegwitNative || addressType === AddressType.SegwitP2SH,\n    server: typeof server !== 'undefined'\n      ? server\n      : (network === NetworkType.Testnet\n        ? DEFAULT_TESTNET_SERVER\n        : DEFAULT_MAINNET_SERVER),\n  }\n}\n\n/** Get sat/byte fee estimate from blockcypher */\nexport async function getBlockcypherFeeEstimate(feeLevel: FeeLevel, networkType: NetworkType): Promise<number> {\n  const body = await request.get(\n    `https://api.blockcypher.com/v1/btc/${networkType === NetworkType.Mainnet ? 'main' : 'test3'}`,\n    { json: true },\n  )\n  const feePerKbField = `${feeLevel}_fee_per_kb`\n  const feePerKb = body[feePerKbField]\n  if (!feePerKb) {\n    throw new Error(`Blockcypher response is missing expected field ${feePerKbField}`)\n  }\n  return feePerKb / 1000\n}\n","import { createUnitConverters } from '@faast/payments-common'\nimport * as bitcoin from 'bitcoinjs-lib'\nimport * as bip32 from 'bip32'\nimport { BitcoinjsNetwork, AddressType } from './types'\nimport { DECIMAL_PLACES } from './constants'\n\nconst {\n  toMainDenominationBigNumber,\n  toMainDenominationString,\n  toMainDenominationNumber,\n  toBaseDenominationBigNumber,\n  toBaseDenominationString,\n  toBaseDenominationNumber,\n} = createUnitConverters(DECIMAL_PLACES)\n\nexport {\n  toMainDenominationBigNumber,\n  toMainDenominationString,\n  toMainDenominationNumber,\n  toBaseDenominationBigNumber,\n  toBaseDenominationString,\n  toBaseDenominationNumber,\n}\n\nexport function isValidXprv(xprv: string, network: BitcoinjsNetwork): boolean {\n  try {\n    return !bip32.fromBase58(xprv, network).isNeutered()\n  } catch(e) {\n    return false\n  }\n}\n\nexport function isValidXpub(xpub: string, network: BitcoinjsNetwork): boolean {\n  try {\n    return bip32.fromBase58(xpub, network).isNeutered()\n  } catch(e) {\n    return false\n  }\n}\n\n/** Return string error if invalid, undefined otherwise */\nexport function validateHdKey(hdKey: string, network: BitcoinjsNetwork): string | undefined {\n  try {\n    bip32.fromBase58(hdKey, network)\n  } catch(e) {\n    return e.toString()\n  }\n}\n\nexport function isValidAddress(address: string, network: BitcoinjsNetwork): boolean {\n  try {\n    bitcoin.address.toOutputScript(address, network)\n    return true\n  } catch (e) {\n    return false\n  }\n}\n\nexport function isValidExtraId(extraId: string): boolean {\n  return false\n}\n\nexport function publicKeyToAddress(publicKey: Buffer, network: BitcoinjsNetwork, addressType: AddressType): string {\n  let script: bitcoin.payments.Payment\n  if (addressType === AddressType.Legacy) {\n    script = bitcoin.payments.p2pkh({ network, pubkey: publicKey })\n  } else { // type is segwit\n    script = bitcoin.payments.p2wpkh({ network, pubkey: publicKey })\n\n    if (addressType === AddressType.SegwitP2SH) {\n      script = bitcoin.payments.p2sh({\n        network,\n        redeem: script\n      })\n    }\n  }\n  const { address } = script\n  if (!address) {\n    throw new Error('bitcoinjs-lib address derivation returned falsy value')\n  }\n  return address\n}\n\nfunction privateKeyToKeyPair(privateKey: string, network: BitcoinjsNetwork) {\n  return bitcoin.ECPair.fromWIF(privateKey, network)\n}\n\nexport function privateKeyToAddress(privateKey: string, network: BitcoinjsNetwork, addressType: AddressType) {\n  const keyPair = privateKeyToKeyPair(privateKey, network)\n  return publicKeyToAddress(keyPair.publicKey, network, addressType)\n}\n\nexport function isValidPrivateKey(privateKey: string, network: BitcoinjsNetwork): boolean {\n  try {\n    privateKeyToKeyPair(privateKey, network)\n    return true\n  } catch (e) {\n    return false\n  }\n}\n","import { payments as bjsPayments, TransactionBuilder, ECPairInterface as ECPair } from 'bitcoinjs-lib'\nimport {\n  NetworkType, FeeRateType, FeeRate, TransactionStatus, AutoFeeLevels\n} from '@faast/payments-common'\n\nimport { getBlockcypherFeeEstimate, toBitcoinishConfig } from './utils'\nimport {\n  BaseBitcoinPaymentsConfig, BitcoinishUnsignedTransaction, BitcoinishPaymentTx,\n  BitcoinishSignedTransaction, AddressType,\n} from './types'\nimport {\n  DEFAULT_SAT_PER_BYTE_LEVELS, DEFAULT_ADDRESS_TYPE,\n} from './constants'\nimport { toBaseDenominationNumber, isValidAddress } from './helpers'\nimport { BitcoinishPayments } from './bitcoinish'\nimport { KeyPair } from './bip44'\n\nexport abstract class BaseBitcoinPayments<Config extends BaseBitcoinPaymentsConfig> extends BitcoinishPayments<Config> {\n  readonly addressType: AddressType\n\n  constructor(config: BaseBitcoinPaymentsConfig) {\n    super(toBitcoinishConfig(config))\n    this.addressType = config.addressType || DEFAULT_ADDRESS_TYPE\n  }\n\n  abstract getKeyPair(index: number): KeyPair\n\n  async isValidAddress(address: string): Promise<boolean> {\n    return isValidAddress(address, this.bitcoinjsNetwork)\n  }\n\n  async getFeeRateRecommendation(feeLevel: AutoFeeLevels): Promise<FeeRate> {\n    let satPerByte: number\n    try {\n      satPerByte = await getBlockcypherFeeEstimate(feeLevel, this.networkType)\n    } catch (e) {\n      satPerByte = DEFAULT_SAT_PER_BYTE_LEVELS[feeLevel]\n      this.logger.warn(\n        `Failed to get bitcoin ${this.networkType} fee estimate, using hardcoded default of ${feeLevel} sat/byte -- ${e.message}`\n      )\n    }\n    return {\n      feeRate: satPerByte.toString(),\n      feeRateType: FeeRateType.BasePerWeight,\n    }\n  }\n\n  async signTransaction(tx: BitcoinishUnsignedTransaction): Promise<BitcoinishSignedTransaction> {\n    const keyPair = this.getKeyPair(tx.fromIndex)\n    const { inputs, outputs } = tx.data as BitcoinishPaymentTx\n\n    let redeemScript = undefined\n    let prevOutScript = undefined\n    if (this.addressType === AddressType.SegwitP2SH) {\n      redeemScript = bjsPayments.p2wpkh({ pubkey: keyPair.publicKey }).output\n    } else if (this.addressType === AddressType.SegwitNative) {\n      prevOutScript = bjsPayments.p2wpkh({ pubkey: keyPair.publicKey }).output\n    }\n\n    let builder = new TransactionBuilder(this.bitcoinjsNetwork)\n    for (let output of outputs) {\n      builder.addOutput(output.address, toBaseDenominationNumber(output.value))\n    }\n    for (let i = 0; i < inputs.length; i++) {\n      const input = inputs[i]\n      builder.addInput(input.txid, input.vout, undefined, prevOutScript)\n    }\n    // Must add all inputs before signing them\n    for (let i = 0; i < inputs.length; i++) {\n      const input = inputs[i]\n      builder.sign(\n        i,\n        keyPair,\n        redeemScript,\n        undefined, // undefined for simple Segwit\n        toBaseDenominationNumber(input.value)\n      )\n    }\n    const built = builder.build()\n    const txId = built.getId()\n    const txHex = built.toHex()\n    return {\n      ...tx,\n      status: TransactionStatus.Signed,\n      id: txId,\n      data: {\n        hex: txHex,\n      },\n    }\n  }\n}\n","import bitcoin, { ECPair } from 'bitcoinjs-lib'\nimport { BIP32Interface as HDNode, fromBase58 } from 'bip32'\nimport { BitcoinjsNetwork, AddressType } from './types'\nimport { publicKeyToAddress } from './helpers'\n\nexport { HDNode }\n\nexport type KeyPair = ECPair.Signer & {\n  privateKey?: Buffer | undefined\n  toWIF(): string\n}\n\n/**\n * Split full path into array of indices\n *\n * @example \"m/44'/0'/0'/1/23\" -> [\"44'\", \"0'\", \"0'\", \"1\", \"23\"]\n */\nexport function splitDerivationPath(path: string): string[] {\n  let parts = path.split('/')\n  if (parts[0] === 'm') {\n    return parts.slice(1)\n  }\n  return parts\n}\n\n/**\n * Derive the base HDNode required for deriveKeyPair, deriveAddress, and derivePrivateKey functions\n *\n * This partially applies the derivation path starting at the already derived depth of the provided key.\n */\nexport function deriveHDNode(hdKey: string, derivationPath: string, network: BitcoinjsNetwork): HDNode {\n  const rootNode = fromBase58(hdKey, network)\n  const parts = splitDerivationPath(derivationPath).slice(rootNode.depth)\n  let node = rootNode\n  if (parts.length > 0) {\n    node = rootNode.derivePath(parts.join('/'))\n  }\n  return node\n}\n\nexport function deriveKeyPair(baseNode: HDNode, index: number, network: BitcoinjsNetwork): KeyPair {\n  return baseNode.derive(0).derive(index)\n}\n\nexport function deriveAddress(\n  baseNode: HDNode, index: number, network: BitcoinjsNetwork, addressType: AddressType,\n): string {\n  const keyPair = deriveKeyPair(baseNode, index, network)\n  return publicKeyToAddress(keyPair.publicKey, network, addressType)\n}\n\nexport function derivePrivateKey(baseNode: HDNode, index: number, network: BitcoinjsNetwork) {\n  const keyPair = deriveKeyPair(baseNode, index, network)\n  return keyPair.toWIF()\n}\n\nexport function xprvToXpub(xprv: string, derivationPath: string, network: BitcoinjsNetwork) {\n  const node = deriveHDNode(xprv, derivationPath, network)\n  return node.neutered().toBase58()\n}\n","import { omit } from 'lodash'\nimport {\n  assertType,\n} from '@faast/ts-common'\nimport bs58 from 'bs58'\nimport { xprvToXpub, deriveAddress, HDNode, deriveHDNode, deriveKeyPair } from './bip44'\nimport {\n  HdBitcoinPaymentsConfig,\n} from './types'\nimport { BaseBitcoinPayments } from './BaseBitcoinPayments'\nimport { DEFAULT_DERIVATION_PATHS } from './constants'\nimport { isValidXprv, isValidXpub, validateHdKey } from './helpers';\nimport { bip32MagicNumberToPrefix } from './utils'\n\nexport class HdBitcoinPayments extends BaseBitcoinPayments<HdBitcoinPaymentsConfig> {\n  readonly derivationPath: string\n  readonly xpub: string\n  readonly xprv: string | null\n  readonly hdNode: HDNode\n\n  constructor(public config: HdBitcoinPaymentsConfig) {\n    super(config)\n    assertType(HdBitcoinPaymentsConfig, config)\n    this.derivationPath = config.derivationPath || DEFAULT_DERIVATION_PATHS[this.addressType]\n\n    if (this.isValidXpub(config.hdKey)) {\n      this.xpub = config.hdKey\n      this.xprv = null\n    } else if (this.isValidXprv(config.hdKey)) {\n      this.xpub = xprvToXpub(config.hdKey, this.derivationPath, this.bitcoinjsNetwork)\n      this.xprv = config.hdKey\n    } else {\n      const providedPrefix = config.hdKey.slice(0, 4)\n      const xpubPrefix = bip32MagicNumberToPrefix(this.bitcoinjsNetwork.bip32.public)\n      const xprvPrefix = bip32MagicNumberToPrefix(this.bitcoinjsNetwork.bip32.private)\n      let reason = ''\n      if (providedPrefix !== xpubPrefix && providedPrefix !== xprvPrefix) {\n        reason = ` with prefix ${providedPrefix} but expected ${xprvPrefix} or ${xpubPrefix}`\n      } else {\n        reason = ` (${validateHdKey(config.hdKey, this.bitcoinjsNetwork)})`\n      }\n      throw new Error(\n        `Invalid ${this.networkType} hdKey provided to bitcoin payments config${reason}`\n      )\n    }\n    this.hdNode = deriveHDNode(config.hdKey, this.derivationPath, this.bitcoinjsNetwork)\n  }\n\n  isValidXprv(xprv: string) {\n    return isValidXprv(xprv, this.bitcoinjsNetwork)\n  }\n\n  isValidXpub(xpub: string) {\n    return isValidXpub(xpub, this.bitcoinjsNetwork)\n  }\n\n  getFullConfig() {\n    return {\n      ...this.config,\n      derivationPath: this.derivationPath,\n      addressType: this.addressType,\n    }\n  }\n\n  getPublicConfig() {\n    return {\n      ...omit(this.getFullConfig(), ['logger', 'server', 'hdKey']),\n      hdKey: this.xpub,\n    }\n  }\n  getAccountId(index: number): string {\n    return this.xpub\n  }\n  getAccountIds(): string[] {\n    return [this.xpub]\n  }\n\n  getAddress(index: number): string {\n    return deriveAddress(this.hdNode, index, this.bitcoinjsNetwork, this.addressType)\n  }\n\n  getKeyPair(index: number) {\n    if (!this.xprv) {\n      throw new Error(`Cannot get private key ${index} - HdBitcoinPayments was created with an xpub`)\n    }\n    return deriveKeyPair(this.hdNode, index, this.bitcoinjsNetwork)\n  }\n}\n","import { BitcoinishPaymentsUtils } from './bitcoinish'\nimport { toBitcoinishConfig } from './utils'\nimport { BitcoinPaymentsUtilsConfig } from './types'\nimport { isValidAddress, isValidPrivateKey } from './helpers'\n\nexport class BitcoinPaymentsUtils extends BitcoinishPaymentsUtils {\n  constructor(config: BitcoinPaymentsUtilsConfig = {}) {\n    super(toBitcoinishConfig(config))\n  }\n\n  async isValidAddress(address: string) {\n    return isValidAddress(address, this.bitcoinjsNetwork)\n  }\n\n  async isValidPrivateKey(privateKey: string) {\n    return isValidPrivateKey(privateKey, this.bitcoinjsNetwork)\n  }\n\n}\n","import { PaymentsFactory } from '@faast/payments-common'\n\nimport { BitcoinPaymentsConfig, HdBitcoinPaymentsConfig } from './types'\nimport { HdBitcoinPayments } from './HdBitcoinPayments'\n\nexport class BitcoinPaymentsFactory implements PaymentsFactory<BitcoinPaymentsConfig> {\n  forConfig(config: BitcoinPaymentsConfig) {\n    if (HdBitcoinPaymentsConfig.is(config)) {\n      return new HdBitcoinPayments(config)\n    }\n    throw new Error('Cannot instantiate bitcoin payments for unsupported config')\n  }\n}\n\nexport default BitcoinPaymentsFactory\n"],"names":["isString","BlockbookBitcoin","isMatchingError","toBigNumber","t.union","t.string","instanceofCodec","t.null","requiredOptionalCodec","NetworkTypeT","nullable","Logger","t.type","t.array","UtxoInfo","extendCodec","BaseUnsignedTransaction","BaseSignedTransaction","BaseTransactionInfo","BaseBroadcastResult","BlockInfoBitcoin","assertType","DelegateLogger","createUnitConverters","isNil","Payport","isUndefined","FeeRateType","isType","FeeOptionCustom","FeeLevel","TransactionStatus","get","AddressType","enumCodec","BaseConfig","FeeRate","t.number","NetworkType","networks","bip32.fromBase58","bitcoin.address","bitcoin.payments","bitcoin.ECPair","bjsPayments","TransactionBuilder","fromBase58","omit"],"mappings":"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"}