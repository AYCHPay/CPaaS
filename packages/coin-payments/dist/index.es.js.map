{"version":3,"file":"index.es.js","sources":["../src/types.ts","../src/utils.ts","../src/constants.ts","../src/CoinPayments.ts"],"sourcesContent":["import * as t from 'io-ts'\nimport { extendCodec, Logger } from '@faast/ts-common'\nimport { NetworkTypeT } from '@faast/payments-common'\nimport { TronPaymentsConfig } from '@faast/tron-payments'\nimport { RipplePaymentsConfig } from '@faast/ripple-payments'\nimport { StellarPaymentsConfig } from '@faast/stellar-payments'\nimport { BitcoinPaymentsConfig } from '@faast/bitcoin-payments'\n\nconst assetConfigCodecs = {\n  TRX: TronPaymentsConfig,\n  XRP: RipplePaymentsConfig,\n  XLM: StellarPaymentsConfig,\n  BTC: BitcoinPaymentsConfig,\n}\nexport const CoinPaymentsAssetConfigs = t.type(assetConfigCodecs, 'CoinPaymentsAssetConfigs')\nexport type CoinPaymentsAssetConfigs = t.TypeOf<typeof CoinPaymentsAssetConfigs>\n\nexport const CoinPaymentsConfig = t.partial(\n  {\n    ...assetConfigCodecs,\n    network: NetworkTypeT,\n    logger: Logger,\n    seed: t.string,\n  },\n  'CoinPaymentsConfig',\n)\nexport type CoinPaymentsConfig = t.TypeOf<typeof CoinPaymentsConfig>\n\nexport const SupportedCoinPaymentsSymbol = t.keyof(assetConfigCodecs, 'SupportedCoinPaymentsSymbol')\nexport type SupportedCoinPaymentsSymbol = t.TypeOf<typeof SupportedCoinPaymentsSymbol>\n","\nexport function keysOf<T extends { [k: string]: any } | { [k: number]: any }>(o: T): (keyof T)[] {\n  return Object.keys(o) as (keyof T)[]\n}\n","import { PaymentsFactory } from '@faast/payments-common'\nimport { TronPaymentsFactory } from '@faast/tron-payments'\nimport { RipplePaymentsFactory } from '@faast/ripple-payments'\nimport { StellarPaymentsFactory } from '@faast/stellar-payments'\nimport { BitcoinPaymentsFactory } from '@faast/bitcoin-payments'\n\nimport { keysOf } from './utils'\nimport { SupportedCoinPaymentsSymbol } from './types'\n\nexport const PAYMENTS_FACTORIES: {\n  [A in SupportedCoinPaymentsSymbol]: PaymentsFactory\n} = {\n  TRX: new TronPaymentsFactory(),\n  XRP: new RipplePaymentsFactory(),\n  XLM: new StellarPaymentsFactory(),\n  BTC: new BitcoinPaymentsFactory(),\n}\n\nexport const SUPPORTED_ASSET_SYMBOLS = keysOf(PAYMENTS_FACTORIES)\n","import * as bip32 from 'bip32'\nimport { assertType, Logger } from '@faast/ts-common'\nimport { PaymentsFactory, AnyPayments, NetworkType } from '@faast/payments-common'\n\nimport { CoinPaymentsConfig, SupportedCoinPaymentsSymbol, CoinPaymentsAssetConfigs } from './types'\nimport { keysOf } from './utils'\nimport { SUPPORTED_ASSET_SYMBOLS, PAYMENTS_FACTORIES } from './constants'\n\nexport class CoinPayments {\n  readonly payments: { [A in SupportedCoinPaymentsSymbol]?: AnyPayments } = {}\n  readonly accountIds: string[]\n  readonly network: NetworkType\n  readonly logger: Logger\n\n  constructor(public readonly config: CoinPaymentsConfig) {\n    assertType(CoinPaymentsConfig, config)\n    this.network = config.network || NetworkType.Mainnet\n    this.logger = config.logger || console\n    const accountIdSet = new Set<string>()\n    SUPPORTED_ASSET_SYMBOLS.forEach((assetSymbol) => {\n      let assetConfig = config[assetSymbol]\n      if (!assetConfig && config.seed) {\n        const xprv = bip32.fromSeed(Buffer.from(config.seed, 'hex')).toBase58()\n        // TODO: make all payments accept seed so we can omit xprv\n        assetConfig = {\n          seed: config.seed,\n          hdKey: xprv,\n        }\n      }\n      if (!assetConfig) {\n        return\n      }\n      if (config.network) {\n        assetConfig.network = config.network\n      }\n      if (config.logger) {\n        assetConfig.logger = config.logger\n      }\n      const assetPayments = PAYMENTS_FACTORIES[assetSymbol].forConfig(assetConfig)\n      this.payments[assetSymbol] = assetPayments\n      assetPayments.getAccountIds().forEach((id) => accountIdSet.add(id))\n    })\n    this.accountIds = Array.from(accountIdSet)\n  }\n\n  static getFactory(assetSymbol: SupportedCoinPaymentsSymbol): PaymentsFactory {\n    const paymentsFactory = PAYMENTS_FACTORIES[assetSymbol]\n    if (!paymentsFactory) {\n      throw new Error(`No payment factory configured for asset symbol ${assetSymbol}`)\n    }\n    return paymentsFactory\n  }\n\n  static getPayments<A extends SupportedCoinPaymentsSymbol>(\n    assetSymbol: A,\n    config: CoinPaymentsAssetConfigs[A],\n  ): AnyPayments {\n    const factory = CoinPayments.getFactory(assetSymbol)\n    return factory.forConfig(config)\n  }\n\n  getPublicConfig(): CoinPaymentsConfig {\n    return keysOf(this.payments).reduce((o, k) => {\n      o[k] = this.forAsset(k).getPublicConfig()\n      return o\n    }, {} as CoinPaymentsConfig)\n  }\n\n  getAccountIds(): string[] {\n    return this.accountIds\n  }\n\n  forAsset(assetSymbol: SupportedCoinPaymentsSymbol): AnyPayments {\n    const assetPayments = this.payments[assetSymbol]\n    if (!assetPayments) {\n      throw new Error(`No payments interface configured for ${assetSymbol}`)\n    }\n    return assetPayments\n  }\n\n  isAssetSupported(assetSymbol: string): assetSymbol is SupportedCoinPaymentsSymbol {\n    return SupportedCoinPaymentsSymbol.is(assetSymbol)\n  }\n\n  isAssetConfigured(assetSymbol: SupportedCoinPaymentsSymbol): boolean {\n    return Boolean(this.payments[assetSymbol])\n  }\n\n}\n\nexport default CoinPayments\n"],"names":["t.type","t.partial","t.string","t.keyof","bip32.fromSeed"],"mappings":"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"}